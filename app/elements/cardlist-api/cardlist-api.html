<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<!--
  API url respons needs to be a JSON list. every object in the list needs a name (string) and a deadline (UNIX-timestamp) field.
-->
<dom-module id="cardslist-api">
  <template>
    <style>
      :host {
        display: block;
      }

      section {
        padding: 5px;
      }

      paper-card {
        padding: 10px;
        height: auto;
        --paper-card-header: {
          background: #E1E1E1;
        }
      }

      /*
        /deep/ is deprecated.
        when paper-card fixes this this line can be removed.
      */
      paper-card /deep/ paper-material {
        height: auto;
      }

      paper-spinner {
        margin: 0 auto;
      }

      paper-button {
        background: #00A6D6;
      }

      .align-right {
        padding: 5px;
        display: block;
        width: 100%;
        text-align: right;
      }

      .center {
        text-align: center;
        width: 100%;
      }
    </style>

    <!--
      API call to {{apiurl}}
      optional {{apiparams}}
    -->
    <iron-ajax
      auto
      url="{{apiurl}}"
      params='{{apiparams}}'
      handle-as="json"
      debounce-duration="300"
      id="ajax"
      loading="{{loading}}"
      last-response="{{responseCollection}}">
    </iron-ajax>

    <!--
      Enables drag & drop features
    -->
    <core-drag-drop></core-drag-drop>

    <section>
      <!--
        While loading, show spinner
      -->
      <template is="dom-if" if="{{loading}}">
        <div class="center">
          <paper-spinner active></paper-spinner>
        </div>
      </template>

      <!--
        Shows if we're not loading data
      -->
      <template is="dom-if" if="{{!loading}}">
        <div class="align-right">
          <paper-icon-button icon="refresh" class="refresh-button" on-click="reLoadList"></paper-icon-button>
        </div>
        <template is="dom-repeat" items="{{responseCollection.items}}" as="responsItem">
          <paper-card heading="{{responsItem.name}}" elevation="2" draggable="true" data-event="{{responsItem}}">
            <div class="card-content">
              Due: <span>{{timeConverter(responsItem.deadline)}}</span>
            </div>
            <div class="card-actions">
              <paper-button>Plan</paper-button>
            </div>
          </paper-card>
        </template>
      </template>

    </section>
  </template>
  <script>
  (function() {
    Polymer({
      is: 'cardslist-api',

      properties: {
        apiurl: "",
        apiparams: "{}"
      },

      reLoadList: function() {
        var ajax = document.querySelector('iron-ajax');
        ajax.generateRequest();
      },
      timeConverter: function(UNIX_timestamp) {
        var a = new Date(UNIX_timestamp * 1000);
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var hour = a.getHours();
        var min = a.getMinutes();
        var sec = a.getSeconds();
        var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
        return time;
      }
    });
  })();
  </script>
</dom-module>
