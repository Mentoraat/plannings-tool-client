<dom-module id="calendar-app">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <iron-ajax
      auto
      id="user"
      url="/v1/users/USER-aba62cd5-caa6-4e42-a5d6-4909f03038bf"
      handle-as="json"
      content-type="application/json"
      last-response="{{user}}"></iron-ajax>
    <iron-ajax
      id="occurrences"
      url="/v1/users/USER-aba62cd5-caa6-4e42-a5d6-4909f03038bf/occurrences"
      handle-as="json"
      content-type="application/json"
      on-response="ajaxResponse"></iron-ajax>
    <full-calendar id="calendar" config="[[config()]]" events="[[eventSources]]"></full-calendar>

    <edit-event-modal id="editEvent" event="{{editEvent}}" on-updated="updateEventFromModal"></edit-event-modal>
  </template>
  <script>
  (function() {
    function correctMoments(event, start, end) {
      event.start = start.tz('Europe/Amsterdam').format('YYYY-MM-DD,HH:mm:ss');
      event.end   = end.tz('Europe/Amsterdam').format('YYYY-MM-DD,HH:mm:ss');
      return event;
    }

    function copy(value) {
      if (value !== null && typeof value === 'object') {
        var copyOfValue = Object.create(Object.getPrototypeOf(value));

        for (var key in value) {
          copyOfValue[key] = copy(value[key]);
        }

        return copyOfValue;
      }

      return value;
    }

    Polymer({
      is: 'calendar-app',

      properties: {
        user: {
          type: Object
        },
        eventSources:  {
          type: Array,
          value: [
              {
                url: '/v1/users/USER-aba62cd5-caa6-4e42-a5d6-4909f03038bf/occurrences',
                eventDataTransform: function(event) {
                  event.start = moment.tz(event.start, 'Europe/Amsterdam');
                  event.end = moment.tz(event.end, 'Europe/Amsterdam');

                  return event;
                }
              }
            ]
        }
      },
      ajaxResponse: function(request) {
        switch (request.target.method) {
          case 'PUT':
            this.$.calendar.updateEvent(request.target.originalEvent);
            this.fire('events-refreshed');
            break;
          case 'POST':
            this.lastEvent.dropped();
            this.$.calendar.renderEvent(request.target.lastResponse);
            break;
        }
      },
      config: function() {
          return {
            editable: true,

            defaultView: 'agendaWeek',
            timeFormat: 'H:mm',
            axisFormat: 'H:mm',
            slotLabelFormat: 'H:mm',
            timezone: 'local',
            height: 'auto',
            firstDay: 1,

            droppable: true,

            header:{
              left: 'agendaDay agendaWeek month',
              center: 'title',
              right: 'today prev,next'
            },

            allDayText: 'All Day',

            dayClick:     this.dayClicked.bind(this),
            eventClick:   this.eventClicked.bind(this),
            eventDrop:    this.updateEvent.bind(this),
            eventResize:  this.updateEvent.bind(this),
            eventAfterRender: this.renderColor.bind(this),
            drop:         (function(that) {
              return function(date) {
                // this references the element dragged in onto the full-calendar
                that.drop(this, date);
              };
              // this references the Polymer object
            })(this)
        };
      },
      dayClicked: function() {
      },
      renderColor: function(event, element) {
        var edition = (event.assignment ? event.assignment : event).course.edition;

        var fn = function() {
          element.css('background-color', this.user.colors[edition.courseId + ',' + edition.year]);
        }.bind(this);

        /*
          It might be the case that full-calendar finishes earlier than the
          user retrieval. Therefore wait till the user response has finished
          and execute the styling.

          If, however, the user was already retrieved, we can start the styling
          right away.
        */
        if (!this.user) {
          this.$.user.addEventListener('response', fn);
        }
        else {
          fn();
        }

        if (event.status === "FINISHED") {
          element.css('border', '#15D115 5px solid');
        }
      },
      eventClicked: function(event) {
        if (event.editable){
          var dialog = this.$.editEvent;
          dialog.event = event;
          dialog.openDialog();
        }
      },
      updateEventFromModal: function(event) {
        this.updateEvent(event.detail);
      },
      updateEvent: function(event) {
        var fixedEvent = {
          status: event.status,
          assignment: event.assignment,
        };

        this.$.occurrences.originalEvent = event;
        this.performAjax('PUT', correctMoments(fixedEvent, event.start, event.end));
      },
      drop: function(event, date) {
        var assignment = copy(event.data);

        var start = date;
        var end = moment(start).add(assignment.length, 'hours');

        var postEvent = {
          assignment: assignment,
          user: {
            id: 1,
            name: 'me',
            uuid: 'aba62cd5-caa6-4e42-a5d6-4909f03038bf',
            accessToken: 'asdf'
          },
          editable: true
        };

        this.lastEvent = event;
        this.performAjax('POST', correctMoments(postEvent, start, end));
      },
      performAjax: function(type, data) {
        var ajax = this.$.occurrences;

        ajax.method = type;

        if (data) {
          ajax.body = data;
        }

        ajax.generateRequest();
      }
    });
  })();
  </script>
</dom-module>
