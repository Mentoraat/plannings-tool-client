<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<dom-module id="login-popup">
  <template>
    <style>
      .loginbg {
        height: 100vh;
        background: url("../images/planningstool-bg.jpg");
        background-position: 25% center;
        background-repeat: no-repeat;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }

      paper-card {
        display: block;
        flex: 1;
        max-width: 450px;
        width: 100%;
        padding: 16px;
        --paper-card-actions: {
          text-align: right;
        }
      }
      .card-actions .login-popup {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }

      paper-button {
        flex: 1;
        background-color: #4285f4;
        color: #f0f0f0;
        text-align: center;
      }

      paper-button.clear {
        flex-grow: 2;
        background-color: #fff;
        color: #333;
      }

      .errormessage {
        color: red;
      }

      paper-input[type="number"] {
        --paper-input-container-input-webkit-spinner: {
          -webkit-appearance: none;
          margin: 0;
        }
      }
    </style>
    <iron-ajax
      id="ajaxLogin"
      url="/v1/authentication"
      method="POST"
      handle-as="json"
      content-type="application/json"
      on-error="handleLoginError"
      on-response="handleResponse"></iron-ajax>

    <iron-ajax
      id="ajaxRegister"
      url="/v1/authentication/register"
      method="POST"
      handle-as="json"
      content-type="application/json"
      on-error="handleRegisterError"
      on-response="handleResponse"></iron-ajax>

    <akc-meta key="token" value="[[token]]"></akc-meta>
    <akc-meta key="uuid" value="[[uuid]]"></akc-meta>

    <template is="dom-if" if="{{loggedIn}}" restamp="true">
      <main-panel></main-panel>
    </template>
    <template is="dom-if" if="{{!loggedIn}}" restamp="true">
      <div class="loginbg">
        <paper-card class="loginCard" heading="{{getHeading(registering)}}">
          <div class="card-content">
            <div hidden$="{{registering}}">
              <paper-input label="Username" type="text" value="{{username}}" on-keydown="enterAndTryLogIn"></paper-input>
              <paper-input label="Password" type="password" value="{{password}}" on-keydown="enterAndTryLogIn"></paper-input>

              <span class="errormessage" hidden$="{{validLogin}}">Failed to log in.</span>
            </div>
            <div hidden$="{{!registering}}">
              <paper-input required auto-validate error-message="needs some text!"
                  label="Username" type="text" value="{{username}}"
                  on-keydown="enterAndTryRegister"></paper-input>
              <paper-input required auto-validate error-message="needs a number!"
                  label="Student number" type="number" value="{{studentnumber}}" min=1000000 max=9999999
                  on-keydown="enterAndTryRegister"></paper-input>
              <paper-input required auto-validate error-message="needs an email address!"
                  label="Student email address" type="email" value="{{email}}"
                  on-keydown="enterAndTryRegister"></paper-input>
              <paper-input required auto-validate error-message="needs some text!"
                  label="Password" type="password" value="{{password}}"
                  on-keydown="enterAndTryRegister"></paper-input>
              <paper-input required auto-validate error-message="needs some text!"
                  label="Retype password" type="password" value="{{secondpassword}}"
                  on-keydown="enterAndTryRegister"></paper-input>

              <span class="errormessage" hidden$="{{samePassword}}">The passwords do not match.</span>
              <span class="errormessage" hidden$="{{registerError}}">[[registerErrorMessage]]</span>
              <span class="errormessage" hidden$="{{fieldsFilled}}">A field is left empty.</span>
            </div>
          </div>
          <div class="card-actions">
            <div hidden$="{{registering}}">
              <paper-button id="forgotpwd1" on-tap="openResetDialog" class="clear">Forgot password?</paper-button>
              <paper-tooltip for="forgotpwd1" position="bottom" animation-delay="0">Not yet implemented. Contact us at gijsw @ ch.tudelft.nl</paper-tooltip>
              <paper-button on-tap="switchForm" raised>Register</paper-button>
              <paper-button on-tap="tryLogIn" raised>Log in</paper-button>
            </div>
            <div hidden$="{{!registering}}">
              <paper-button id="forgotpwd2" on-tap="openResetDialog" class="clear">Forgot password?</paper-button>
              <paper-tooltip for="forgotpwd2" position="bottom" animation-delay="0">Not yet implemented. Contact us at gijsw @ ch.tudelft.nl</paper-tooltip>
              <paper-button on-tap="switchForm" raised>Cancel</paper-button>
              <paper-button on-tap="tryRegister" raised>Register</paper-button>
            </div>
          </div>
        </paper-card>
      </div>
    </template>
  </template>
  <script>
    Polymer({
      is: 'login-popup',
      properties: {
        loggedIn: {
          type: Boolean,
          value: false
        }
      },
      ready: function() {
        this.samePassword = true;
        this.validLogin = true;
        this.registerError = true;
        this.fieldsFilled = true;
        this.registering = false;
      },
      handleResponse: function(request) {
        this.token = request.target.lastResponse.token;
        this.uuid = request.target.lastResponse.uuid;
        this.loggedIn = true;
      },

      enterAndTryLogIn: function(event) {
        this.validLogin = true;
        // If keyCode is [Enter], try the login.
        if (event.keyCode === 13) {
          this.tryLogIn();
        }
      },

      enterAndTryRegister: function(event) {
        this.registerError = true;
        this.fieldsFilled = true;

        // If keyCode is [Enter], try register.
        if (event.keyCode === 13) {
          this.tryRegister();
        }
      },

      tryLogIn: function() {
        this.validLogin = true;

        var ajax = this.$.ajaxLogin;
        ajax.body = {
          username: this.username.toLowerCase(),
          password: this.password
        };
        ajax.generateRequest();
      },
      tryRegister: function() {
        if (this.password !== this.secondpassword) {
          this.samePassword = false;
          return;
        }

        if (!(this.username && this.password && this.studentnumber)) {
          this.fieldsFilled = false;
          return;
        }

        this.samePassword = true;

        var ajax = this.$.ajaxRegister;
        ajax.body = {
          username: this.username.toLowerCase(),
          email: this.email,
          password: this.password,
          studentnumber: this.studentnumber
        };
        ajax.generateRequest();
      },
      switchForm: function() {
        this.registering = !this.registering;
      },
      getHeading: function(registering) {
        return registering ? 'Register' : 'Log In';
      },

      handleLoginError: function() {
        this.validLogin = false;
      },

      handleRegisterError: function(e) {
        this.registerError = false;
        var response = e.detail.request.response;
        this.registerErrorMessage = response ? response.message : 'Server failure. Please try again later.';
      },

      openResetDialog: function() {
        window.alert('Not yet implemented. Contact us at gijsw @ ch.tudelft.nl');
      }
    });
  </script>
</dom-module>
